<!DOCTYPE html>
<html>

<head>
    <title>Simple HTML Text Editor</title>
    <script src="https://cdn.ckeditor.com/ckeditor5/38.1.1/classic/ckeditor.js"></script>
    <script src="https://js.arcgis.com/4.21/"></script>
</head>

<body>
    PW Review #/ Amendment Comments / Changes

    <div id="editor"></div>

    <button onclick="submitData()">Submit</button>

    <div id="message"></div>

    <script>
        // Replace with your REST API URL
        const urlParams = new URLSearchParams(window.location.search);
        const oid = urlParams.get('oid'); // Default to 'Fort Worth' if no parameter provided
        const QUERY_API_URL = 'https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/0/query';
        const UPDATE_API_URL = 'https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/0/updateFeatures';

        let editorData = "";
        let objectID = null;

        let editor;

        require(["esri/identity/IdentityManager", "esri/request", "dojo/domReady!"], function(IdentityManager, esriRequest) {
            ClassicEditor.create(document.querySelector('#editor'), {})
                .then(editorInstance => {
                    editor = editorInstance;
                    editor.editing.view.change(writer => {
                        writer.setStyle('height', '300px', editor.editing.view.document.getRoot());
                    });

                    fetchEditorData();

                    editor.model.document.on('change:data', () => {
                        editorData = editor.getData().replace(/<span style="color: rgb\((\d+,\s*\d+,\s*\d+)\);">(.*?)<\/span>/gi, '<span style="color:rgb($1);">$2</span>');
                    });

                    return editor;
                })
                .catch(error => {
                    console.error(error);
                });

            function fetchEditorData() {
                esriRequest(QUERY_API_URL, {
                    responseType: "json",
                    query: {
                        f: 'json',
                        where: "OBJECTID=" + oid,
                        outFields: '*'
                    }
                }).then(function(response) {
                    let data = response.data;
                    let attributeData = data.features[0].attributes.PWReview2Comments;
                    objectID = data.features[0].attributes.OBJECTID;
                    editorData = attributeData;
                    editor.setData(attributeData);
                });
            }

            // Function to display a message to the user
            function showMessage(message) {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = message;
            }

            // Function to submit data back to REST API
            window.submitData = function() {
                // Create features array with updated data
                const features = [{
                    "attributes": {
                        "OBJECTID": objectID,
                        "PWReview2Comments": editorData
                    }
                }];

                // Convert features to URL-encoded string
                const formData = new URLSearchParams();
                formData.append('f', 'json');
                formData.append('features', JSON.stringify(features));

                // Post data to REST API
                esriRequest(UPDATE_API_URL, {
                    method: 'post',
                    responseType: 'json',
                    body: formData
                }).then(function(response) {
                    let data = response.data;
                    if (data.updateResults && data.updateResults[0].success) {
                        showMessage('Data successfully posted');
                    } else {
                        showMessage('Failed to post data');
                    }
                }).catch((error) => {
                    console.error('Error:', error);
                    showMessage('Error: ' + error);
                });
            }
        });
    </script>

</body>

</html>